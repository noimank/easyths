# QuantTrader 快速入门指南

## 概述

QuantTrader 是一个基于同花顺交易软件的自动化交易系统，通过 REST API 接口提供程序化交易功能。本指南将帮助您快速搭建和使用该系统。

## 环境准备

### 系统要求

- **操作系统**: Windows 10/11（必需，因为需要使用 pywinauto）
- **Python**: 3.8 或更高版本
- **同花顺交易客户端**: 已安装并配置好账户

### 安装步骤

1. **克隆项目**
```bash
git clone https://github.com/your-repo/QuantTrader.git
cd QuantTrader
```

2. **创建虚拟环境**
```bash
python -m venv venv
venv\Scripts\activate  # Windows
```

3. **安装依赖**
```bash
pip install -r requirements.txt
```

4. **配置环境变量**
```bash
# 复制配置文件模板
cp .env.example .env

# 编辑配置文件，修改以下关键配置
notepad .env
```

### 配置说明

在 `.env` 文件中需要配置以下关键参数：

```env
# 同花顺交易客户端路径
TRADING_APP_PATH="C:/同花顺远航版/transaction/xiadan.exe"

# API服务配置
API_HOST="0.0.0.0"
API_PORT=8000

# API密钥（请修改为安全的密钥）
API_KEY=your_secure_api_key_here
```

## 启动服务

### 方式一：命令行启动

```bash
# 启动开发服务器
python -m uvicorn src.main:app --reload --host 0.0.0.0 --port 8000
```

### 方式二：直接运行

```bash
# 运行主程序
python src/main.py
```

服务启动后，访问 `http://localhost:8000/docs` 可以查看自动生成的 API 文档。

## 首次使用

### 1. 启动同花顺交易客户端

确保同花顺交易客户端已正常启动并登录。

### 2. 验证系统状态

使用以下命令检查系统是否正常：

```bash
curl -X GET http://localhost:8000/api/v1/system/health \
  -H "Authorization: Bearer your_api_key"
```

成功响应示例：
```json
{
  "success": true,
  "message": "系统运行正常",
  "data": {
    "status": "healthy",
    "components": {
      "automator": "connected",
      "logged_in": true
    }
  }
}
```

### 3. 查看可用操作

```bash
curl -X GET http://localhost:8000/api/v1/operations/ \
  -H "Authorization: Bearer your_api_key"
```

## 基础操作示例

### Python 示例

创建 `test_trading.py` 文件：

```python
import requests
import time
import json

# 配置
BASE_URL = "http://localhost:8000"
API_KEY = "your_api_key"

headers = {
    "Authorization": f"Bearer {API_KEY}",
    "Content-Type": "application/json"
}

def execute_operation(operation_name, params):
    """执行操作并等待结果"""
    # 提交操作
    response = requests.post(
        f"{BASE_URL}/api/v1/operations/{operation_name}",
        headers=headers,
        json={"params": params}
    )

    if not response.json()["success"]:
        print(f"操作提交失败: {response.json()}")
        return None

    operation_id = response.json()["data"]["operation_id"]
    print(f"操作已提交，ID: {operation_id}")

    # 等待操作完成
    while True:
        status_response = requests.get(
            f"{BASE_URL}/api/v1/operations/{operation_id}/status",
            headers=headers
        )

        status_data = status_response.json()["data"]
        status = status_data["status"]
        print(f"操作状态: {status}")

        if status in ["completed", "failed", "cancelled"]:
            if status == "completed":
                print("操作成功完成!")
                print(f"结果: {json.dumps(status_data['result'], indent=2, ensure_ascii=False)}")
            else:
                print(f"操作失败: {status_data.get('error', '未知错误')}")
            break

        time.sleep(1)

    return status_data

# 示例1：查询资金信息
print("=== 查询资金 ===")
execute_operation("funds_query", {"query_type": "all"})

# 示例2：查询持仓
print("\n=== 查询持仓 ===")
execute_operation("holding_query", {"return_type": "json"})

# 示例3：买入股票（测试时请谨慎）
# print("\n=== 买入股票 ===")
# execute_operation("buy", {
#     "stock_code": "000001",
#     "price": 10.50,
#     "quantity": 100
# })

# 示例4：批量操作
print("\n=== 批量查询 ===")
batch_response = requests.post(
    f"{BASE_URL}/api/v1/operations/batch",
    headers=headers,
    json={
        "operations": [
            {"name": "funds_query", "params": {"query_type": "total"}},
            {"name": "holding_query", "params": {}}
        ],
        "mode": "parallel"
    }
)

print(f"批量操作提交: {batch_response.json()}")
```

### JavaScript/Node.js 示例

创建 `test_trading.js` 文件：

```javascript
const fetch = require('node-fetch');

// 配置
const BASE_URL = 'http://localhost:8000';
const API_KEY = 'your_api_key';

const headers = {
    'Authorization': `Bearer ${API_KEY}`,
    'Content-Type': 'application/json'
};

async function executeOperation(operationName, params) {
    // 提交操作
    const response = await fetch(`${BASE_URL}/api/v1/operations/${operationName}`, {
        method: 'POST',
        headers,
        body: JSON.stringify({ params })
    });

    const result = await response.json();
    if (!result.success) {
        console.log('操作提交失败:', result);
        return null;
    }

    const operationId = result.data.operation_id;
    console.log(`操作已提交，ID: ${operationId}`);

    // 等待操作完成
    while (true) {
        const statusResponse = await fetch(
            `${BASE_URL}/api/v1/operations/${operationId}/status`,
            { headers }
        );

        const statusData = (await statusResponse.json()).data;
        const status = statusData.status;
        console.log(`操作状态: ${status}`);

        if (['completed', 'failed', 'cancelled'].includes(status)) {
            if (status === 'completed') {
                console.log('操作成功完成!');
                console.log('结果:', JSON.stringify(statusData.result, null, 2));
            } else {
                console.log(`操作失败: ${statusData.error || '未知错误'}`);
            }
            break;
        }

        await new Promise(resolve => setTimeout(resolve, 1000));
    }

    return statusData;
}

// 示例使用
(async () => {
    // 查询资金
    console.log('=== 查询资金 ===');
    await executeOperation('funds_query', { query_type: 'all' });

    // 查询持仓
    console.log('\n=== 查询持仓 ===');
    await executeOperation('holding_query', { return_type: 'json' });
})();
```

### Postman 示例

1. 导入环境变量：
   - 变量名：`base_url`，值：`http://localhost:8000`
   - 变量名：`api_key`，值：`your_api_key`

2. 请求示例：

**查询系统健康状态**
```
GET {{base_url}}/api/v1/system/health
Headers:
  Authorization: Bearer {{api_key}}
```

**买入股票**
```
POST {{base_url}}/api/v1/operations/buy
Headers:
  Authorization: Bearer {{api_key}}
  Content-Type: application/json

Body (raw JSON):
{
  "params": {
    "stock_code": "000001",
    "price": 10.50,
    "quantity": 100
  }
}
```

## 常见问题

### Q: 提示"连接到同花顺失败"
**A**:
1. 确保同花顺交易客户端已启动
2. 检查 .env 文件中的 TRADING_APP_PATH 路径是否正确
3. 确保同花顺客户端已登录账户

### Q: API 认证失败
**A**:
1. 检查请求头中是否包含正确的 Authorization
2. 确认 API_KEY 配置正确
3. 确保使用 Bearer Token 格式

### Q: 操作超时
**A**:
1. 检查同花顺客户端是否有弹窗或确认对话框
2. 调整 TRADING_TIMEOUT 环境变量（默认30秒）
3. 确保网络连接正常

### Q: 股票代码格式错误
**A**:
- A股代码必须是6位数字，如"000001"
- 不需要包含交易所后缀（如.SZ, .SH）

### Q: 买入/卖出数量错误
**A**:
- 数量必须是100的倍数
- 最小买入数量为100股

## 进阶使用

### 1. 自定义超时和重试

```python
# 在请求中设置优先级
response = requests.post(
    f"{BASE_URL}/api/v1/operations/buy",
    headers=headers,
    json={
        "params": {
            "stock_code": "000001",
            "price": 10.50,
            "quantity": 100
        },
        "priority": 5  # 优先级 0-10
    }
)
```

### 2. 批量操作

```python
# 顺序执行多个操作
batch_data = {
    "operations": [
        {"name": "funds_query", "params": {}},
        {"name": "buy", "params": {"stock_code": "000001", "price": 10.5, "quantity": 100}},
        {"name": "funds_query", "params": {}}
    ],
    "mode": "sequential",  # 顺序执行
    "stop_on_error": True  # 遇到错误停止
}

response = requests.post(
    f"{BASE_URL}/api/v1/operations/batch",
    headers=headers,
    json=batch_data
)
```

### 3. 监控队列状态

```python
# 获取队列统计
response = requests.get(
    f"{BASE_URL}/api/v1/queue/stats",
    headers=headers
)

stats = response.json()["data"]
print(f"队列中待处理操作数: {stats['pending'] + stats['queued']}")
```

## 安全建议

1. **保护 API 密钥**：不要在代码中硬编码 API 密钥，使用环境变量
2. **网络安全**：在生产环境中使用 HTTPS
3. **操作限制**：设置合理的操作频率限制
4. **日志审计**：定期检查操作日志
5. **权限控制**：限制 API 的访问来源

## 下一步

- 阅读 [API接口文档](./API接口文档.md) 了解完整接口
- 查看 [开发指南](./开发指南.md) 学习如何扩展功能
- 参考示例代码开发自己的交易策略

## 技术支持

如遇到问题，请：

1. 查看日志文件 `logs/trading.log`
2. 使用系统状态接口检查运行情况
3. 在 GitHub Issues 中提交问题
4. 联系技术支持：noimank@163.com